{% extends 'base/base_adminlte.html' %}

{% block extra_head %}

{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="container pb-2 text-center d-flex justify-content-between col-12">
        <strong style="font-size: 1.5rem; color: #1E3A5F;"><i class="bi bi-folder-plus" style="color: #4caf50;"></i> {{ document.code_name|default:"Sin Código" }}</strong> <a href="{{ document.file.url }}" class="btn btn-primary" download>Descargar archivo</a>
        {% if document.file.name|lower|slice:'-4:' == '.pdf' %}
        <a target="_blank" href="{% url 'firmarElectronicamente' document.id %}" type="button" class="btn btn-outline-success">Firmar</a>
        {% endif %}
    </div>
    {% if file_error %} 
    <div class="alert alert-danger" role="alert">
        {{file_error}}
    </div>
    {% endif %}
    {% if document.file.name|lower|slice:'-4:' == '.pdf' %}
        <!-- Visualización de PDF -->
        <embed src="data:application/pdf;base64,{{ file_base64 }}" 
        type="application/pdf" 
        width="100%" 
        height="700px">
        
    {% elif document.file.name|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif' %}
        <!-- Controles de rotación -->
        <div class="text-center mb-3">
            <button class="btn btn-secondary me-2" onclick="rotateImage(-90)">
                <i class="bi bi-arrow-counterclockwise"></i> Rotar Izquierda
            </button>
            <button class="btn btn-secondary" onclick="rotateImage(90)">
                <i class="bi bi-arrow-clockwise"></i> Rotar Derecha
            </button>
        </div>

        <!-- Contenedor flexible con scroll y adaptabilidad -->
        <div id="image-container"
            style="width: 100%; height: 80vh; display: flex; justify-content: center; align-items: center; overflow: auto; background: #f8f9fa;">
            <div id="image-wrapper" style="max-width: 100%; max-height: 100%; overflow: auto;">
                <img id="rotatable-image"
                    src="data:{{ mime_type }};base64,{{ file_base64 }}"
                    alt="{{ document.code_name }}"
                    style="width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; transform: rotate(270deg); transition: transform 0.3s ease;"
                >
            </div>
        </div>

        <!-- Script para rotación -->
        <script>
        let currentRotation = 270;
        let naturalWidth, naturalHeight;

        function updateContainerSize() {
            const image = document.getElementById("rotatable-image");
            const wrapper = document.getElementById("image-wrapper");
            
            // Intercambiamos dimensiones cuando la rotación es 90 o 270 grados
            if (currentRotation % 180 === 90) {
                wrapper.style.maxWidth = '100%';
                wrapper.style.maxHeight = '100%';
            } else {
                wrapper.style.maxWidth = '100%';
                wrapper.style.maxHeight = '100%';
            }
        }

        function rotateImage(degrees) {
            const image = document.getElementById("rotatable-image");
            currentRotation = (currentRotation + degrees + 360) % 360;
            image.style.transform = `rotate(${currentRotation}deg)`;
            updateContainerSize();
        }

        // Inicialización
        window.addEventListener("load", () => {
            const image = document.getElementById("rotatable-image");
            
            if (image.complete) {
                naturalWidth = image.naturalWidth;
                naturalHeight = image.naturalHeight;
                updateContainerSize();
            } else {
                image.onload = () => {
                    naturalWidth = image.naturalWidth;
                    naturalHeight = image.naturalHeight;
                    updateContainerSize();
                };
            }
        });
        </script>
    {% elif document.file.name|lower|slice:'-4:' in '.mp4,.ogg' %}
        <!-- Visualización de video -->
        <video width="100%" controls>
            <source src="data:video/{{ document.file.name|lower|slice:'-3:' }};base64,{{ file_base64 }}" type="video/{{ document.file.name|lower|slice:'-3:' }}">
            Tu navegador no soporta el elemento de video.
        </video>
    {% elif document.file.name|lower|slice:'-4:' in '.webm' %}
        <!-- Visualización de video -->
        <video width="100%" controls>
            <source src="data:video/{{ document.file.name|lower|slice:'-4:' }};base64,{{ file_base64 }}" type="video/{{ document.file.name|lower|slice:'-4:' }}">
            Tu navegador no soporta el elemento de video.
        </video>
    {% else %}
        <!-- Descarga para otros formatos -->
        <p>Este tipo de archivo no puede ser visualizado directamente.</p>
        
    {% endif %}
</div>
{% endblock %}