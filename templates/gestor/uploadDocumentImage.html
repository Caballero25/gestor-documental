{% extends 'base/base_adminlte.html' %}
 {% load static %} 
 {% block title %}Subir Documento con Cámara {% endblock %} 
 {% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  #camera-container, .camera-container {
    position: relative;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    border: 2px dashed #ddd;
    border-radius: 5px;
    min-height: 200px;
    display: flex;
    height: 700px;
    justify-content: center;
    align-items: center;
    aspect-ratio: 4/1; /* Fijo para 4:1 */
    overflow: hidden;
    background-color: #f0f0f0; /* Fondo visible cuando la cámara no llena el espacio */
  }

  .camera-view {
    width: auto;
    height: 100%;
    object-fit: cover; /* Prioriza llenar el contenedor verticalmente */
  }
  
  .camera-canvas {
    display: none;
  }

  .captured-image {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: contain; /* Muestra toda la imagen capturada */
    border: 1px solid #ccc;
    background: white;
  }

  .camera-placeholder {
    text-align: center;
    padding: 20px;
  }
  .camera-buttons {
    margin-top: 15px;
    text-align: center;
  }
  .metadata-section {
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 4px;
  }
  .error-message {
    color: #dc3545;
    margin-top: 5px;
  }
  /* Media query para dispositivos móviles */
  @media (max-width: 768px) {
    #camera-container, .camera-container {
      max-height: 80vh; /* Altura aún más reducida en móviles */
    }
  }
    .seq-bubble {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 1.2rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .seq-bubble:hover {
    background-color: #0069d9;
    transform: translateY(-50%) scale(1.05);
  }

  /* Para dispositivos móviles */
  @media (max-width: 768px) {
    .seq-bubble {
      width: 30px;
      height: 30px;
      font-size: 1rem;
      right: 10px;
    }
  }
</style>
{% endblock %} 
{% block content %}
<div class="container-fluid">
  {% if messages %} {% for message in messages %}
  <div class="alert alert-success d-flex align-items-center" role="alert">
    <div>{{ message }}</div>
  </div>
  {% endfor %} {% endif %}
</div>
<div class="card card-primary card-outline">
  <div class="row p-2">
    <div class="col-4">Digitalización</div>
    <div class="col-8">
      <div class="input-group">
        <label for="seq-value-display"></label>
        <select class="form-control" id="seq-selector">
          {% for secuencial in secuenciales %}
          <option value="{{secuencial.id}}">{{secuencial.libro}}</option>
          {% endfor %}
        </select>
        <input
          type="text"
          id="seq-value-display"
          class="form-control ml-1"
          readonly
        />
        <button
          type="button"
          id="change-seq-btn"
          class="btn btn-outline-secondary"
        >
          C. secuencia
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div class="form-group">
      <label for="aspect-ratio">Relación de Aspecto</label>
      <select class="form-select" id="aspect-ratio">
        <option value="16:9">16:9 (Widescreen)</option>
        <option value="16:3">9:3 (Personalizada)</option>
        <option value="3:1">3:1 (Personalizada)</option>
        <option value="4:1">4:1 (Personalizada)</option>
        <option value="5:2">5:2 (Personalizada)</option>
        <option value="4:3">4:3 (Estándar)</option>
        <option value="1:1">1:1 (Cuadrado)</option>
        <option value="3:2">3:2 (Fotografía)</option>
        <option value="auto">Auto (Dispositivo)</option>
      </select>
    </div>
    <form id="document-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-group">
        <label for="id_code_name">Nombre/Identificador (opcional)</label>
        <input
          type="text"
          class="form-control"
          id="id_code_name"
          name="code_name"
          placeholder="Identificador para buscar el documento posteriormente"
        />
      </div>

      <div class="form-group">
        <label for="id_metadata_schema">Esquema de Metadatos</label>
        <select
          class="form-select"
          id="id_metadata_schema"
          name="metadata_schema"
        >
          <option value="">--- Seleccione un esquema ---</option>
          {% for schema in metadata_schemas %}
          <option value="{{ schema.id }}">{{ schema.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group form-check d-none">
        <input
          type="checkbox"
          class="form-check-input"
          id="no_metadata"
          name="metadata"
        />
        <label class="form-check-label" for="no_metadata"
          >Subir sin metadatos</label
        >
      </div>

      <div class="form-group">
        <label>Capturar Documento 1 (Principal)</label>
        <div id="camera-container-1" class="camera-container">
          <video id="camera-view-1" class="camera-view" autoplay playsinline></video>
          <canvas id="camera-canvas-1" class="camera-canvas" style="display: none;"></canvas>
          <img id="captured-image-1" class="captured-image" alt="Documento capturado 1" style="display: none;"/>
        </div>
        <div class="camera-buttons">
          <button type="button" id="capture-btn-1" class="btn btn-success btn-lg">
            <i class="bi bi-camera"></i> 1
          </button>
          <button
            type="button"
            id="retake-btn-1"
            class="btn btn-warning btn-lg"
            disabled
          >
            <i class="bi bi-arrow-clockwise">Reintentar</i>
          </button>
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-paper-plane"></i> Enviar
          </button>
          <div class="mt-1">
          <button type="button" id="add-second-photo-btn" class="btn btn-info">
            <i class="fas fa-plus"></i> Añadir segunda foto (opcional)
          </button>
     </div>
        </div>
        <div id="camera-error-1" class="error-message"></div>
        <input
          type="file"
          class="d-none"
          id="formFile"
          name="file"
        />
      </div>

      <div id="camera-section-2" class="form-group" style="display: none;">
        <label>Capturar Documento 2 (Opcional)</label>
        <div id="camera-container-2" class="camera-container">
          <video id="camera-view-2" class="camera-view" autoplay playsinline></video>
          <canvas id="camera-canvas-2" class="camera-canvas" style="display: none;"></canvas>
          <img id="captured-image-2" class="captured-image" alt="Documento capturado 2" style="display: none;"/>
        </div>
        <div class="camera-buttons">
          <button type="button" id="capture-btn-2" class="btn btn-success btn-lg">
            <i class="bi bi-camera"></i> 2
          </button>
          <button
            type="button"
            id="retake-btn-2"
            class="btn btn-warning btn-lg"
            disabled
          >
            <i class="bi bi-arrow-clockwise">Reintentar</i>
          </button>
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-paper-plane"></i> Enviar
          </button>
        </div>
        <div id="camera-error-2" class="error-message"></div>
        <input
          type="file"
          class="d-none"
          id="formFile2"
          name="file2"
        />
      </div>

      <div id="metadata-fields" class="metadata-section">
        <h5>Metadatos del Documento</h5>
        <p class="text-muted">
          Seleccione un esquema de metadatos para ver los campos
        </p>
        </div>

      <div class="form-group mt-4">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-paper-plane"></i> Enviar Documento
        </button>
      </div>
    </form>
    <div id="seq-bubble" class="seq-bubble" title="Secuencia actual"></div>
  </div>
</div>
<script>
  $(document).ready(function () {
    // --- INICIO: CÓDIGO DE PERSISTENCIA DE DATOS ---
    const persistentFields = ['metadata_PARROQUIA', 'metadata_TOMO', 'metadata_AÑO'];

    // Función para cargar los valores guardados en los campos del formulario
    function loadPersistentFields() {
      persistentFields.forEach(fieldId => {
        const savedValue = localStorage.getItem(fieldId);
        if (savedValue) {
          const field = $(`#${fieldId}`);
        if (field.length) {
        field.val(savedValue);
        }
        }
      });
    }

    // Evento que guarda el valor de un campo CADA VEZ que el usuario lo modifica
    // Se usa delegación de eventos para que funcione con campos creados dinámicamente.
    $("#metadata-fields").on("change", "#metadata_PARROQUIA, #metadata_TOMO, #metadata_AÑO", function() {
      if (this.value) {
        // Guarda el valor en localStorage usando el ID del campo como clave
        localStorage.setItem(this.id, this.value);
      } else {
        // Si el usuario borra el campo, también lo eliminamos del recuerdo
          localStorage.removeItem(this.id);
      }
    });
    // --- FIN: CÓDIGO DE PERSISTENCIA DE DATOS ---
    // --- CONFIGURACIÓN GENERAL ---
    cargarValorSecuencia();
    let isSaving = false;

    // --- OBJETOS DE CÁMARA ---
    // Creamos objetos para mantener los elementos y el estado de cada cámara
    const camera1 = {
        stream: null,
        container: $("#camera-container-1"),
        view: document.getElementById("camera-view-1"),
        canvas: document.getElementById("camera-canvas-1"),
        captureBtn: $("#capture-btn-1"),
        retakeBtn: $("#retake-btn-1"),
        capturedImage: $("#captured-image-1"),
        fileInput: $("#formFile"),
        errorDisplay: $("#camera-error-1")
    };

    const camera2 = {
        stream: null,
        container: $("#camera-container-2"),
        view: document.getElementById("camera-view-2"),
        canvas: document.getElementById("camera-canvas-2"),
        captureBtn: $("#capture-btn-2"),
        retakeBtn: $("#retake-btn-2"),
        capturedImage: $("#captured-image-2"),
        fileInput: $("#formFile2"),
        errorDisplay: $("#camera-error-2")
    };
    
    // --- FUNCIONES DE CÁMARA REFACTORIZADAS ---
    // Estas funciones ahora aceptan un objeto de cámara para trabajar
    
    function getConstraints(aspectRatio) {
      const baseConstraints = {
        video: {
          facingMode: "environment",
          audio: false,
        },
      };

      const resolutions = {
        "16:9": { width: 1920, height: 1080 },
        "16:3": { width: 1920, height: 360 },
        "3:1": { width: 1440, height: 480 },
        "4:1": { width: 1600, height: 400 },
        "5:2": { width: 1200, height: 480 },
        "4:3": { width: 1632, height: 1224 },
        "1:1": { width: 1512, height: 1512 },
        "3:2": { width: 2016, height: 1344 },
        auto: { width: { ideal: 2048 }, height: { ideal: 1080 } },
      };

      if (aspectRatio === "auto") {
        return baseConstraints;
      }

      if (resolutions[aspectRatio]) {
        baseConstraints.video.width = { ideal: resolutions[aspectRatio].width };
        baseConstraints.video.height = {
          ideal: resolutions[aspectRatio].height,
        };
        baseConstraints.video.aspectRatio =
          parseFloat(aspectRatio.split(":")[0]) /
          parseFloat(aspectRatio.split(":")[1]);
      }

      return baseConstraints;
    }

    function stopCamera(cam) {
        if (cam.stream) {
            cam.stream.getTracks().forEach(track => track.stop());
            cam.view.srcObject = null;
            $(cam.view).hide();
            cam.stream = null;
        }
    }

    function startCamera(cam) {
        stopCamera(cam);
        cam.errorDisplay.text("");
        const aspectRatio = $("#aspect-ratio").val();
        const constraints = getConstraints(aspectRatio);

        navigator.mediaDevices.getUserMedia(constraints)
            .then(mediaStream => {
                cam.stream = mediaStream;
                cam.view.srcObject = mediaStream;
                $(cam.view).show();
                cam.captureBtn.prop("disabled", false);

                cam.view.onloadedmetadata = () => {
                    cam.canvas.width = cam.view.videoWidth;
                    cam.canvas.height = cam.view.videoHeight;
                    console.log(`Cámara lista: ${cam.view.videoWidth}x${cam.view.videoHeight}`);
                };
            })
            .catch(error => {
                console.error("Error de cámara:", error);
                let errorMessage = `Error al acceder a la cámara: ${error.name}. Verifique los permisos.`;
                if (error.name === "NotFoundError") {
                    errorMessage = "No se encontró una cámara compatible.";
                }
                cam.errorDisplay.text(errorMessage);
            });
    }

    function captureImage(cam) {
        if (!cam.stream) return;
        const context = cam.canvas.getContext("2d");
        context.drawImage(cam.view, 0, 0, cam.canvas.width, cam.canvas.height);

        cam.capturedImage.attr("src", cam.canvas.toDataURL("image/jpeg", 0.9)).show();

        cam.canvas.toBlob(blob => {
            const jpgFile = new File([blob], "documento.jpg", { type: "image/jpeg" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(jpgFile);
            cam.fileInput[0].files = dataTransfer.files;

            cam.captureBtn.prop("disabled", true);
            cam.retakeBtn.prop("disabled", false);
            stopCamera(cam);
        }, "image/jpeg", 0.9);
    }

    function retakeImage(cam) {
        cam.fileInput.val("");
        cam.capturedImage.hide().attr("src", "");
        cam.retakeBtn.prop("disabled", true);
        cam.captureBtn.prop("disabled", false);
        startCamera(cam);
    }

    // --- EVENT LISTENERS ---

    // Iniciar la primera cámara al cargar la página
    startCamera(camera1);

    // Event listeners para la Cámara 1
    camera1.captureBtn.on("click", () => captureImage(camera1));
    camera1.retakeBtn.on("click", () => retakeImage(camera1));
    
    // Event listeners para la Cámara 2
    camera2.captureBtn.on("click", () => captureImage(camera2));
    camera2.retakeBtn.on("click", () => retakeImage(camera2));

    // Mostrar e iniciar la segunda cámara cuando se hace clic en el botón
$("#add-second-photo-btn").on("click", function() {
    const cameraSection2 = $("#camera-section-2");
    cameraSection2.slideDown(function() {
    // Se ejecuta cuando la animación de slideDown termina
    startCamera(camera2);
 
// AÑADIR ESTA LÍNEA PARA EL SCROLL
    cameraSection2[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
});

  $(this).hide(); // Ocultar el botón después de hacer clic
});
    
    // Reiniciar cámaras si cambia la relación de aspecto
    $("#aspect-ratio").change(function() {
        retakeImage(camera1); // Reinicia la cámara principal para aplicar el cambio
        if ($("#camera-section-2").is(":visible")) {
            retakeImage(camera2); // Reinicia la segunda si está visible
        }
    });

    // Manejar cambio de esquema de metadatos
    $("#id_metadata_schema").change(function () {
      const schemaId = $(this).val();
      const noMetadataChecked = $("#no_metadata").is(":checked");
      const metadataSection = $("#metadata-fields");

      if (schemaId && !noMetadataChecked) {
        // Obtener campos de metadatos dinámicos via AJAX
        $.get(
          `/gestor/get_metadata_fields/?schema_id=${schemaId}`,
          function (data) {
            metadataSection.empty();

            if (data.fields && data.fields.length > 0) {
              metadataSection.append("<h5>Metadatos del Documento</h5>");

              data.fields.forEach(function (field) {
                let fieldHtml = "";
                const fieldId = `metadata_${field.name.replace(/\s+/g, "_")}`;

                switch (field.field_type) {
                  case "text":
                    fieldHtml = `
                                    <div class="form-group">
                                        <label for="${fieldId}">${field.name}</label>
                                        <input type="text" class="form-control" id="${fieldId}" 
                                               name="${fieldId}">
                                    </div>
                                `;
                    break;
                  case "number":
                    fieldHtml = `
                                    <div class="form-group">
                                        <label for="${fieldId}">${field.name}</label>
                                        <input type="number" class="form-control" id="${fieldId}" 
                                               name="${fieldId}">
                                    </div>
                                `;
                    break;
                  case "date":
                    fieldHtml = `
                                    <div class="form-group">
                                        <label for="${fieldId}">${field.name}</label>
                                        <input type="date" class="form-control" id="${fieldId}" 
                                               name="${fieldId}">
                                    </div>
                                `;
                    break;
                  case "select":
                    let options = field.options || [];
                    if (typeof options === "string") {
                      try {
                        options = JSON.parse(options);
                      } catch (e) {
                        options = options.split(",");
                      }
                    }

                    let selectOptions = options
                      .map(
                        (opt) =>
                          `<option value="${opt.trim()}">${opt.trim()}</option>`
                      )
                      .join("");

                    fieldHtml = `
                                    <div class="form-group">
                                        <label for="${fieldId}">${field.name}</label>
                                        <select class="form-select" id="${fieldId}" 
                                                name="${fieldId}">
                                            <option value="">--- Seleccione ---</option>
                                            ${selectOptions}
                                        </select>
                                    </div>
                                `;
                    break;
                  case "checkbox":
                    fieldHtml = `
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" 
                                               id="${fieldId}" name="${fieldId}">
                                        <label class="form-check-label" for="${fieldId}">
                                            ${field.name}
                                        </label>
                                    </div>
                                `;
                    break;
                }

                metadataSection.append(fieldHtml);
              });
            } else {
              metadataSection.append(
                '<p class="text-muted">Este esquema no tiene campos de metadatos definidos</p>'
              );
            }
            loadPersistentFields();
          }
        ).fail(function () {
          metadataSection.html(
            '<div class="alert alert-danger">Error al cargar los campos de metadatos</div>'
          );
        });
      } else {
        metadataSection.html(
          '<p class="text-muted">Seleccione un esquema de metadatos para ver los campos</p>'
        );
      }
    });

    // Manejar el checkbox de "Subir sin metadatos"
    $("#no_metadata").change(function () {
      if ($(this).is(":checked")) {
        $("#id_metadata_schema").val("").trigger("change");
      }
    });

    // Validar formulario antes de enviar
    $("#document-form").submit(function (e) {
      e.preventDefault();
      if (isSaving) {
        console.log("El formulario ya se está enviando, por favor espere...");
        return;
      }

            // --- 1. VALIDACIÓN DE ESQUEMA OBLIGATORIO ---
      const schemaSelector = $("#id_metadata_schema");
      const noMetadataCheckbox = $("#no_metadata");

      if (!schemaSelector.val() || noMetadataCheckbox.is(":checked")) {
        Swal.fire({
            icon: 'error',
            title: 'Esquema Requerido',
            text: 'Es obligatorio seleccionar un esquema. La opción "Subir sin metadatos" debe estar desactivada.',
            confirmButtonText: 'Entendido'
        });
        // Añadir feedback visual si no se ha seleccionado un esquema
        if (!schemaSelector.val()){
            schemaSelector.addClass('is-invalid');
        }
        return; // DETIENE EL ENVÍO
      } else {
        schemaSelector.removeClass('is-invalid');
      }

      // --- 2. VALIDACIÓN DE CAMPO "TOMO" OBLIGATORIO ---
      const tomoField = $("[name='metadata_TOMO']");

      // La condición ahora es: el campo TOMO no existe O (existe pero está vacío)
      if (tomoField.length === 0 || !tomoField.val()) {
        Swal.fire({
            icon: 'error',
            title: 'Campo Requerido',
            text: 'El esquema seleccionado exige el campo "TOMO", el cual es obligatorio y no puede estar vacío.',
            confirmButtonText: 'Entendido'
        });
        // Si el campo existe pero está vacío, se le añade la clase de error
        if (tomoField.length > 0) {
             tomoField.addClass('is-invalid').focus();
             if (tomoField.next('.invalid-feedback').length === 0) {
                 tomoField.after('<div class="invalid-feedback">Este campo es requerido.</div>');
             }
        }
        return; // DETIENE EL ENVÍO
      } else {
        // Si pasa la validación, se limpia cualquier clase de error previa
        tomoField.removeClass('is-invalid');
        tomoField.next('.invalid-feedback').remove();
      }

      const fileInput1 = document.getElementById("formFile");
      if (!fileInput1.files || fileInput1.files.length === 0) {
        Swal.fire({
            icon: 'error',
            title: 'Falta el documento principal',
            text: 'Por favor, capture al menos la primera imagen antes de enviar.',
            confirmButtonText: 'Entendido'
        });
        return;
      }

      isSaving = true;
      const submitButton = $('button[type="submit"]');
      submitButton.prop("disabled", true).html(
        '<i class="fas fa-spinner fa-spin"></i> Guardando...'
      );

      const formData = new FormData(this);
      const selectedId = $("#seq-selector").val();
      formData.append("sequence_id", selectedId);
      
      $.ajax({
        url: "", // Se envía al mismo URL de la vista
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          if (response.success) {
            Swal.fire({
              icon: "success",
              title: "Documento guardado",
              text: "El documento se ha guardado correctamente.",
              showConfirmButton: false,
              timer: 1500,
            });
            // Resetear todo para la siguiente captura
            loadPersistentFields();
            retakeImage(camera1);
            if ($("#camera-section-2").is(":visible")) {
                retakeImage(camera2);
                $("#camera-section-2").hide();
                $("#add-second-photo-btn").show();
            }
            $("#id_metadata_schema").trigger("change"); // Limpia los campos de metadatos
            cargarValorSecuencia();
            $("#camera-container-1")[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
              window.scrollBy({ top: 40, behavior: 'smooth' });
            }, 500);
          } else {
            Swal.fire({
              icon: "error",
              title: "Error al guardar",
              text: "Ocurrió un error: " + JSON.stringify(response.errors),
            });
          }
        },
        error: function (xhr, status, error) {
          console.error("Error en la petición:", error);
          Swal.fire({
              icon: "error",
              title: "Error de conexión",
              text: "No se pudo procesar el formulario. Intente de nuevo.",
            });
        },
        complete: function() {
            isSaving = false;
            submitButton.prop("disabled", false).html(
                '<i class="fas fa-paper-plane"></i> Enviar'
            );
        }
      });
    });
  
    // --- FUNCIONES DE SECUENCIA ---
    function cargarValorSecuencia() {
        const selectedId = $("#seq-selector").val();
        $.get(`{% url 'get_seq_value' %}`, { id: selectedId }, function (data) {
        if (data.success) {
            $("#seq-value-display").val(data.seq_value);
            $("#seq-bubble").text(data.seq_value);
        } else {
            $("#seq-value-display").val("Error");
            $("#seq-bubble").text("E");
        }
        }).fail(function () {
        $("#seq-value-display").val("Error");
        $("#seq-bubble").text("E");
        });
    }

    $("#change-seq-btn").click(function () {
        const selectedId = $("#seq-selector").val();

        Swal.fire({
        title: "Nuevo valor de la secuencia",
        input: "number",
        inputLabel: "Ingrese el valor inicial deseado",
        inputAttributes: {
            min: 1,
        },
        showCancelButton: true,
        confirmButtonText: "Guardar",
        cancelButtonText: "Cancelar",
        inputValidator: (value) => {
            if (!value || parseInt(value) < 1) {
            return "Ingrese un número válido mayor o igual a 1";
            }
        },
        }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
            url: "{% url 'set_seq_value' %}",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                id: selectedId,
                seq_value: parseInt(result.value),
            }),
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // Asegurar token CSRF
            success: function (data) {
                Swal.fire({
                icon: "success",
                title: "Secuencia actualizada",
                showConfirmButton: false,
                timer: 1000,
                });
                cargarValorSecuencia();
            },
            error: function () {
                Swal.fire("Error", "No se pudo actualizar la secuencia", "error");
            },
            });
        }
        });
    });

    $("#seq-selector").change(function () {
        cargarValorSecuencia();
    });
  });
</script>
{% endblock %}