{% extends 'base/base_adminlte.html' %}
{% load static %}

{% block extra_head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        .toolbar { width: 250px; background: #f5f5f5; padding: 20px; }
        .canvas-container { flex: 1; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
        #pdf-canvas { border: 1px solid #ccc; background: white; }
        .tool-btn { display: block; width: 100%; margin: 10px 0; padding: 10px; }
        .password-container {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .password-container label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
        }
        #page-switcher-bar {
            position: sticky; /* Se mantiene visible si la página hace scroll */
            top: 0;
            z-index: 1020; /* Encima de otros elementos */
        }

        #page-switcher .page-btn {
            padding: 5px 10px;
            font-size: 0.875rem;
            border: 1px solid #dee2e6;
            background-color: #fff;
            color: #495057;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #page-switcher .page-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        #page-switcher .page-btn.active {
            font-weight: bold;
            color: #fff;
            background-color: #0d6efd; /* Azul de Bootstrap */
            border-color: #0d6efd;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid d-flex flex-column vh-100">
        
        <div id="page-switcher-bar" class="bg-light border-bottom shadow-sm">
            <div id="page-switcher" class="d-flex flex-wrap justify-content-center align-items-center p-2 gap-2">
                </div>
        </div>

        <div class="d-flex flex-grow-1" style="overflow-y: hidden;">
            
            <div class="toolbar-container bg-light border-end">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-light border-0">
                        <h4 class="card-title mb-0"><i class="bi bi-tools me-2"></i>Herramientas</h4>
                    </div>
                    <div class="card-body overflow-auto">
                        <div class="d-grid gap-2 mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="addImage('{{ document.file.url }}', 'file')">
                                <i class="bi bi-image me-1"></i>Agregar Imagen 1
                            </button>
                            {% if document.file2 %}
                            <button class="btn btn-outline-primary btn-sm" onclick="addImage('{{ document.file2.url }}', 'file2')">
                                <i class="bi bi-image me-1"></i>Agregar Imagen 2
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-dark btn-sm" onclick="addTitle()">
                                <i class="bi bi-type-h1 me-1"></i>Agregar Título
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="addText()">
                                <i class="bi bi-text-paragraph me-1"></i>Agregar Texto
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="addDynamicText()">
                                <i class="bi bi-input-cursor-text me-1"></i>Texto Dinámico
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="addPage()">
                                <i class="bi bi-plus-square me-1"></i>Agregar Página
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteSelectedObject()">
                                <i class="bi bi-trash me-1"></i>Eliminar Objeto
                            </button>
                        </div>
                        
                        <div class="border-top pt-3 mt-3">
                            <div class="password-container">
                                <label for="cert-password" class="form-label">
                                    <i class="bi bi-shield-lock me-1"></i>Contraseña de Firma Digital
                                </label>
                                <input type="password" id="cert-password" class="form-control form-control-sm" placeholder="(Opcional)">
                                <small class="form-text text-muted">Llene solo si desea firmar el PDF.</small>
                            </div>
                        </div>

                        <div class="border-top pt-3 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-danger" onclick="generatePDF()">
                                    <i class="bi bi-file-pdf me-1"></i>Generar PDF
                                </button>
                                <button id="download-pdf-btn" class="btn btn-success" style="display: none;" onclick="downloadGeneratedPDF()">
                                    <i class="bi bi-download me-1"></i>Descargar PDF
                                </button>
                                <button class="btn btn-outline-secondary" onclick="saveTemplate()">
                                    <i class="bi bi-save me-1"></i>Guardar Plantilla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <div class="canvas-container flex-grow-1 p-3" style="overflow: auto; background-color: #f8f9fa;">
                <canvas id="pdf-canvas" width="800" height="1000"></canvas>
            </div>

        </div> 
    </div>
    <script>
        let canvas = new fabric.Canvas('pdf-canvas');
        let currentPage = 1;
        let pages;
        let generatedPdfBlob = null;
        
        const dynamicTextContent = "{{ document.generar_texto_final|escapejs }}";

        const file1Url = {% if document.file %}'{{ document.file.url }}'{% else %}null{% endif %};
        const file2Url = {% if document.file2 %}'{{ document.file2.url }}'{% else %}null{% endif %};

        function setBackgroundFit(url) {
        const canvasW = canvas.getWidth();
        const canvasH = canvas.getHeight();

        fabric.Image.fromURL(url, function(img) {
            img.set({
            originX: 'left',
            originY: 'top',
            left: 0,
            top: 0,
            selectable: false,
            evented: false
            });

            img.scaleX = canvasW / img.width;
            img.scaleY = canvasH / img.height;

            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
        }, { crossOrigin: 'anonymous' });
        }

        setBackgroundFit("{% static 'img/bg_pdf.png' %}");

        window.addEventListener('resize', () => {
        setBackgroundFit("{% static 'img/bg_pdf.png' %}");
        });

        (function () {
        const proto = CanvasRenderingContext2D.prototype;
        const desc = Object.getOwnPropertyDescriptor(proto, 'textBaseline');

        Object.defineProperty(proto, 'textBaseline', {
            set(val) {
            if (val === 'alphabetical') val = 'alphabetic'; // CORRECCIÓN
            if (desc && desc.set) return desc.set.call(this, val);
            this._textBaseline = val;
            },
            get() {
            return desc && desc.get ? desc.get.call(this) : this._textBaseline;
            },
            configurable: true,
            enumerable: true
        });
        })();

        /**
         * Renderiza los botones del paginador (Página 1, Página 2, etc.)
         */
function updatePageSwitcher() {
        // Apunta al div correcto dentro de la nueva barra
        const switcher = document.getElementById('page-switcher');
        
        // Limpiar botones existentes
        switcher.innerHTML = '';
        
        Object.keys(pages).sort((a, b) => a - b).forEach(pageNum => {
            const btn = document.createElement('button');
            btn.innerText = `Pág ${pageNum}`;
            
            // Asignar las nuevas clases CSS para los botones
            btn.className = "page-btn";
            
            // Resaltar la página actual
            if (pageNum == currentPage) {
                btn.classList.add('active'); // Clase 'active' para el estilo
            }
            
            btn.onclick = () => switchPage(parseInt(pageNum));
            switcher.appendChild(btn);
        });
    }

        /**
         * Cambia la vista del canvas a una página diferente
         */
        function switchPage(pageNum) {
            if (pageNum === currentPage) return; // No hacer nada si ya estamos en la página

            console.log(`Cambiando a página ${pageNum}`);
            
            // 1. Limpiar el canvas (esto solo quita las referencias visuales)
            // Los objetos siguen existiendo en nuestro array `pages`
            canvas.clear(); 
            //Volver a aplicar la imagen de fondo
            setBackgroundFit("{% static 'img/bg_pdf.png' %}");
            
            // 2. Establecer la nueva página actual
            currentPage = pageNum;
            
            // 3. (Asegurar que la página existe en el objeto)
            if (!pages[currentPage]) {
                pages[currentPage] = [];
            }
            
            // 4. Volver a agregar los objetos de la NUEVA página al canvas
            pages[currentPage].forEach(element => {
                canvas.add(element.object);
            });
            
            // 5. Renderizar los nuevos objetos
            canvas.renderAll();
            
            // 6. Actualizar los botones del paginador
            updatePageSwitcher();
        }

        
function addImage(imageField, fieldName) {
            
            fabric.Image.fromURL(imageField, function(img) {
                
                const canvasWidth = canvas.getWidth();
                const canvasHeight = canvas.getHeight();
                let scaleFactor = 1.0; 

                const maxWidth = canvasWidth * 0.25;
                if (img.width > maxWidth) {
                    scaleFactor = maxWidth / img.width;
                }

                img.scale(scaleFactor);

                const scaledWidth = img.getScaledWidth();
                const scaledHeight = img.getScaledHeight();
                const leftPos = (canvasWidth - scaledWidth) / 2;
                const topPos = (canvasHeight - scaledHeight) / 2;

                img.set({
                    left: leftPos,
                    top: topPos,
                    angle: 0,
                    padding: 10,
                    cornerSize: 6,
                    hasRotatingPoint: true
                });
                
                canvas.add(img);
                pages[currentPage].push({
                    type: 'image',
                    image_field: fieldName,
                    object: img
                });
            });
        }

        function addTitle() {
            const text = new fabric.IText('TÍTULO', {
                left: 100,
                top: 50,
                fontFamily: 'Times New Roman',
                fontSize: 14, 
                fontWeight: 'bold',
                fill: 'black'
            });
            
            canvas.add(text);
            // Usamos el mismo tipo 'text', el backend manejará el estilo
            pages[currentPage].push({
                type: 'text',
                object: text
            });
        }
        
        function addText() {
            const text = new fabric.IText('Texto editable', {
                left: 100,
                top: 100,
                fontFamily: 'Times New Roman',
                fontSize: 12,
                fill: 'black'
            });
            console.log(text)
            
            canvas.add(text);
            pages[currentPage].push({
                type: 'text',
                object: text
            });
        }
        
        function addDynamicText() {
            const dynamicText = "{{ document.generar_texto_final|escapejs }}";
            
            const text = new fabric.IText(dynamicText, {
                left: 100,
                top: 200,
                fontFamily: 'Times New Roman',
                fontSize: 12,
                fill: 'black',
                width: 400
            });
            
            canvas.add(text);
            pages[currentPage].push({
                type: 'dynamic_text',
                object: text
            });
        }
        
        function addPage() {
            // Obtener el siguiente número de página
            const newPageNum = Object.keys(pages).length + 1;
            
            // Crear el array para la nueva página
            pages[newPageNum] = [];
            
            // Actualizar la UI del paginador para mostrar el nuevo botón
            updatePageSwitcher();
            
            // Cambiar automáticamente a la nueva página creada
            switchPage(newPageNum); 
            
            //alert(`Página ${newPageNum} agregada`);
            Swal.fire({
                title: '¡Hecho!',
                text: `Página ${newPageNum} agregada`,
                icon: 'success',
                timer: 1500, 
                showConfirmButton: false,
            });
            
        }

        function saveTemplate() {
            const templateConfig = buildTemplateConfig();
            
            Swal.fire({
                title: 'Guardar Plantilla',
                text: '¿Desea guardar/sobrescribir esta plantilla para todos los documentos de este tipo?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                // Si el usuario confirma...
                if (result.isConfirmed) {
                    
                    // Mostramos un indicador de "guardando..."
                    Swal.fire({
                        title: 'Guardando...',
                        text: 'Por favor espere.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Ejecutamos el fetch
                    fetch(`{% url 'save_template' document.id %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(templateConfig)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Alerta de Éxito
                            Swal.fire(
                                '¡Guardado!',
                                'Plantilla guardada exitosamente.',
                                'success'
                            );
                        } else {
                            // Alerta de Error (controlado)
                            Swal.fire(
                                'Error',
                                'Error al guardar: ' + (data.error || 'Error desconocido'),
                                'error'
                            );
                        }
                    })
                    .catch(err => {
                        console.error('Error en fetch:', err);
                        // Alerta de Error (de conexión)
                        Swal.fire(
                            'Error de Conexión',
                            'No se pudo conectar con el servidor.',
                            'error'
                        );
                    });
                }
            });
        }

/**
         * Reconstruye el canvas a partir de una plantilla guardada
         */
        function loadTemplate(templateConfig) {
            try {
                pages = {}; // Reiniciar 'pages'
                let imageLoadPromises = []; // Para manejar la carga asíncrona

                templateConfig.pages.forEach(page => {
                    const pageNum = page.page_number;
                    pages[pageNum] = []; // Crear el array para la página
                    
                    page.elements.forEach(element => {
                        const commonOptions = {
                            left: element.x,
                            top: element.y,
                            angle: element.rotation || 0,
                            // Opciones comunes de control
                            padding: 10,
                            cornerSize: 6,
                            hasRotatingPoint: true
                        };

                        if (element.type === 'image') {
                            let imageUrl;
                            
                            // Usar las variables JS seguras definidas arriba
                            if (element.image_field === 'file') imageUrl = file1Url;
                            if (element.image_field === 'file2') imageUrl = file2Url;
                            
                            if (imageUrl) { // Si la URL no es null...
                                const promise = new Promise((resolve) => {
                                    fabric.Image.fromURL(imageUrl, function(img) {
                                        img.set({
                                            ...commonOptions,
                                            // Ajustar escala para que coincida con el tamaño guardado
                                            scaleX: element.width / img.width,
                                            scaleY: element.height / img.height
                                        });
                                        pages[pageNum].push({ type: 'image', image_field: element.image_field, object: img });
                                        resolve();
                                    });
                                });
                                imageLoadPromises.push(promise);
                            }
                        } else if (element.type === 'text' || element.type === 'dynamic_text') {
                            // Los textos son síncronos
                            
                            // IMPORTANTE: Si es texto dinámico, usamos el contenido de ESTE documento
                            let textContent = (element.type === 'dynamic_text') 
                                                ? dynamicTextContent 
                                                : element.lines.join('\n');
                            
                            const textObj = new fabric.IText(textContent, {
                                ...commonOptions,
                                fontFamily: element.font_family,
                                fontSize: element.font_size,
                                fontWeight: element.font_weight || 'normal',
                                fill: 'black',
                                width: element.width // Usamos el ancho guardado
                            });
                            
                            pages[pageNum].push({ type: element.type, object: textObj });
                        }
                    });
                });

                // Esperar a que todas las imágenes carguen antes de renderizar
                Promise.all(imageLoadPromises).then(() => {
                    console.log("Plantilla cargada, imágenes procesadas.");
                    
                    currentPage = 1; // Aseguramos que la página actual es 1
                    
                    canvas.clear(); // Limpiamos el canvas
                    setBackgroundFit("{% static 'img/bg_pdf.png' %}"); // Reaplicamos el fondo
                    
                    // Dibujamos los objetos de la página 1
                    if (pages[currentPage]) { 
                        pages[currentPage].forEach(element => {
                            canvas.add(element.object);
                        });
                    }
                    canvas.renderAll(); // ¡Renderizamos!

                    updatePageSwitcher(); // Mostrar botones de página
                });

            } catch (e) {
                console.error("Error crítico al cargar plantilla:", e);
                // Si falla, volver al estado inicial
                pages = {1: []};
                updatePageSwitcher();
            }
        }

        function generatePDF() {
            // 1. Obtener la configuración y la contraseña
            const templateConfig = buildTemplateConfig();
            const certPassword = document.getElementById('cert-password').value;

            // 2. Crear el payload completo
            const payload = {
                template_config: templateConfig,
                certificate_password: certPassword || null // Enviar null si está vacío
            };
            
            // 3. Ocultar botón de descarga y limpiar blob
            document.getElementById('download-pdf-btn').style.display = 'none';
            generatedPdfBlob = null; 

            // 4. Mostrar alerta de "Generando"
            Swal.fire({
                title: 'Generando PDF...',
                text: 'Por favor espere. Este proceso puede tardar si se incluye la firma.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`{% url 'generate_pdf' document.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload) // Enviar el payload completo
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    // Si falla, el backend enviará un JSON con el error
                    return response.json().then(errData => {
                        throw new Error(errData.error || 'Error desconocido en el servidor');
                    });
                }
            })
            .then(blob => {
                // 5. ÉXITO: Guardar blob, mostrar botón y alerta
                generatedPdfBlob = blob; 
                document.getElementById('download-pdf-btn').style.display = 'block';

                Swal.fire({
                    title: '¡PDF Listo!',
                    text: 'Tu documento ha sido generado. Ya puedes descargarlo.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            })
            .catch(err => {
                // 6. ERROR: Manejar errores (de red o de la firma)
                console.error('Error en fetch:', err);
                document.getElementById('download-pdf-btn').style.display = 'none';
                Swal.fire(
                    'Error al Generar',
                    err.message || 'No se pudo conectar con el servidor.',
                    'error'
                );
            });
        }
        /**
         * Inicia la descarga del PDF que está guardado en la variable global
         */
        function downloadGeneratedPDF() {
            if (!generatedPdfBlob) {
                Swal.fire('Error', 'No se encontró ningún PDF para descargar. Genéralo primero.', 'error');
                return;
            }

            const url = window.URL.createObjectURL(generatedPdfBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'documento_generado.pdf';

            document.body.appendChild(a);
            a.click();

            // Limpieza
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        function buildTemplateConfig() {
            const config = {
                page_size: [595.27, 841.89], // A4
                pages: []
            };
            
            for (const [pageNum, pageElements] of Object.entries(pages)) {
                const pageConfig = {
                    page_number: parseInt(pageNum),
                    elements: []
                };
                
                pageElements.forEach(element => {
                    const obj = element.object;
                    const elementConfig = {
                        type: element.type,
                        rotation: obj.angle || 0
                    };
                    
                    // Para imágenes
                    if (element.type === 'image') {
                        const bounds = obj.getBoundingRect();
                        
                        elementConfig.x = bounds.left || 0;
                        elementConfig.y = bounds.top || 0;
                        elementConfig.image_field = element.image_field;
                        elementConfig.width = bounds.width || 100;
                        elementConfig.height = bounds.height || 100;
                    }
                    
                    // Para texto
                    if (element.type === 'text' || element.type === 'dynamic_text') {
                        const bounds = obj.getBoundingRect();

                        elementConfig.x = bounds.left || 0;
                        elementConfig.y = bounds.top || 0;

                        elementConfig.lines = obj.textLines || (obj.text ? [obj.text] : []);
                        
                        elementConfig.font_size = obj.fontSize || 12;
                        elementConfig.font_family = obj.fontFamily || 'Times New Roman';
                        elementConfig.font_weight = obj.fontWeight || 'normal';
                    }
                    
                    console.log(`Elemento ${element.type}:`, elementConfig);
                    pageConfig.elements.push(elementConfig);
                });
                
                config.pages.push(pageConfig);
            }
            
            console.log('Configuración completa:', config);
            return config;
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function deleteSelectedObject() {
            const activeObject = canvas.getActiveObject();
            
            if (!activeObject) {
                // Si no hay nada seleccionado, muestra una alerta
                Swal.fire('Atención', 'Seleccione un elemento para eliminar', 'warning');
                return;
            }

            // 1. Elimina el objeto del canvas de Fabric.js
            canvas.remove(activeObject);
            
            pages[currentPage] = pages[currentPage].filter(
                element => element.object !== activeObject
            );
            
            // Opcional: Deseleccionar (por si acaso)
            canvas.discardActiveObject();
            canvas.renderAll();
        }
        (function() {
            // El backend nos pasa la plantilla como un string JSON
            const savedTemplateString = '{{ plantilla_json|default:"null"|escapejs }}';
            
            try {
                const savedTemplate = JSON.parse(savedTemplateString);
                
                if (savedTemplate) {
                    console.log("Plantilla encontrada, cargando...");
                    loadTemplate(savedTemplate);
                } else {
                    console.log("No hay plantilla, iniciando en blanco.");
                    pages = {1: []};
                    updatePageSwitcher();
                }
            } catch (e) {
                console.error("Error al parsear plantilla JSON:", e);
                pages = {1: []};
                updatePageSwitcher();
            }
        })();
    </script>
{% endblock %}